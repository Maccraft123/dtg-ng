#!/bin/bash
set -e

export DTGROOT=$1
export DEVICE=$2
export SD=$3

mkdir -p $DTGROOT/tmp
cd $DTGROOT/tmp

# missing: networkmanager 

$DTGROOT/alpine-chroot-install/alpine-chroot-install -a aarch64 -d $DTGROOT/tmp/root

echo 'http://dl-cdn.alpinelinux.org/alpine/latest-stable/testing' >> $DTGROOT/tmp/root/etc/apk/repositories
sed -i'' 's/latest-stable/edge/g' $DTGROOT/tmp/root/etc/apk/repositories

chroot $DTGROOT/tmp/root apk update
chroot $DTGROOT/tmp/root apk upgrade

chroot $DTGROOT/tmp/root apk add eudev
chroot $DTGROOT/tmp/root setup-udev || true
chroot $DTGROOT/tmp/root apk add mesa-dri-gallium mesa git ncurses supertuxkart retroarch kodi kodi-peripheral-joystick brightnessctl sudo alsa-utils libretro-ppsspp ncurses-dev ttf-dejavu linux-headers
chroot $DTGROOT/tmp/root apk add sway xfce4-terminal xwayland

chroot $DTGROOT/tmp/root adduser -g "DTG User" -s /bin/ash -D user

chroot $DTGROOT/tmp/root adduser user video
chroot $DTGROOT/tmp/root adduser user audio
chroot $DTGROOT/tmp/root adduser user input

sed -i'' 's/tty1::/#tty1::/g' $DTGROOT/tmp/root/etc/inittab
echo 'tty1::respawn:/bin/login -f user' >> $DTGROOT/tmp/root/etc/inittab
echo 'ttyS0::respawn:/sbin/getty 115200 vt100 ' >> $DTGROOT/tmp/root/etc/inittab

chroot $DTGROOT/tmp/root passwd -d root

echo 'export WLR_LIBINPUT_NO_DEVICES=1' >> $DTGROOT/tmp/root/home/user/.profile
echo 'export XDG_RUNTIME_DIR=/xdg/$(id -u)' >> $DTGROOT/tmp/root/home/user/.profile
echo 'sudo mkdir -p $XDG_RUNTIME_DIR 2>/dev/null' >> $DTGROOT/tmp/root/home/user/.profile
echo 'sudo chown user:user $XDG_RUNTIME_DIR' >> $DTGROOT/tmp/root/home/user/.profile
echo 'chmod 700 $XDG_RUNTIME_DIR' >> $DTGROOT/tmp/root/home/user/.profile
echo 'tty | grep tty1 && exec sway' >> $DTGROOT/tmp/root/home/user/.profile
echo '[ -n "$WAYLAND_DISPLAY" ] && ( while true; do dtg-launcher; done )' >> $DTGROOT/tmp/root/home/user/.profile

cp $DTGROOT/device/$DEVICE/sway-config $DTGROOT/tmp/root/etc/sway/config
cp $DTGROOT/device/$DEVICE/i3status.conf $DTGROOT/tmp/root/etc/i3status.conf

# todo: odroid go advance
cp $DTGROOT/device/$DEVICE/retroarch.cfg $DTGROOT/tmp/root/etc/retroarch.cfg

mkdir -p $DTGROOT/tmp/root/dtg-ng/programs
cp -r $DTGROOT/programs/* $DTGROOT/tmp/root/dtg-ng/programs/

chmod a+x $DTGROOT/tmp/root/dtg-ng/programs/dtg-launcher/install
chmod a+x $DTGROOT/tmp/root/dtg-ng/programs/dtg-stats/install
chmod a+x $DTGROOT/tmp/root/dtg-ng/programs/usb_mass_helper
chroot $DTGROOT/tmp/root/ /dtg-ng/programs/dtg-launcher/install
chroot $DTGROOT/tmp/root/ /dtg-ng/programs/dtg-stats/install

chmod a+w $DTGROOT/tmp/root/etc/sudoers
echo 'user ALL=(ALL:ALL) NOPASSWD: ALL' >> $DTGROOT/tmp/root/etc/sudoers
chmod a-w $DTGROOT/tmp/root/etc/sudoers

mkdir $DTGROOT/tmp/root/data
echo '/dev/mmcblk0p2 /data vfat rw,umask=0000 0 0' > $DTGROOT/tmp/root/etc/fstab
echo 'tmpfs /tmp tmpfs defaults,nosuid,nodev 0 0' >> $DTGROOT/tmp/root/etc/fstab
